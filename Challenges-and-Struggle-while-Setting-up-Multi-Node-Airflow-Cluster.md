Проблемы и трудности при настройке Multi-Node Airflow Cluster

Последней статьей, которую я написал об Apache Airflow, была «Установка и настройка Multi-Node Airflow Cluster с HDP Ambari и Celery для конвейеров данных». Вопрос был в том, прошло ли все гладко или возникли проблемы. Да, были некоторые проблемы.

В этой статье я расскажу о тех проблемах, с которыми я столкнулся в своем путешествии по настройке Multi-Node Airflow Cluster.

Проблема 1. После изменения LocalExecutor на CeleryExecutor группа доступности базы данных находилась в режиме выполнения, но на самом деле ни одна из задач не запускалась.

Worker не смог связаться с Scheduler с помощью Celery.

Ошибка:

 

Я начал изучать код Airflow в той же строке, где возникла ошибка, но не понимал, что происходит. Но причина была ясна. Celery не могла публиковать сообщения или подписываться на них и не имела возможности участвовать в канале связи.

Решение:

Установленная версия Celery была 3.3.5 (которая слишком старая и несовместима с Airflow 1.10 (текущая установленная версия).

 

Проблема 2: после запуска DAG на CeleryExecutor DAG завершился с какой-то странной ошибкой, по крайней мере, для меня.

 

Решение:

Я не смог ничего понять об этой ошибке.

Я изучил блог о airflow на китайском языке: https://blog.csdn.net/u013492463/article/details/80881260

Я ничего не понял, но, по крайней мере, получил небольшое представление о том, что может быть причиной этой ошибки.

Более ранняя настройка:

 

Я понимаю, что pyamqp был бы лучшим выбором, так как многие люди использовали его, и более ранняя статья в некоторой степени давала такое же разрешение.

amqp: // - это псевдоним, который использует librabbitmq, если он доступен, или py-amqp, если его нет.

Вы должны использовать pyamqp: // или librabbitmq: //, если хотите точно указать, какой протокол передачи данных использовать. Протокол передачи данных pyamqp: // использует библиотеку amqp (http://github.com/celery/py-amqp)

Позднее произвел установку с разрешением:

 

изменение amqp на pyamqp устранило указанную выше ошибку.

Установка:

 

Проблема 3: сбой подключения SQL Alchemy

Более ранняя конфигурация:

SQL alchemy connection

 

Решение:

Более поздняя конфигурация:

 

Для psycopg2 вам необходимо установить pip wheel.

Установите адаптер PostGreSQL: psycopg2

Psycopg - это адаптер PostgreSQL для языка программирования Python.

 

Проблема 4: HDP версия 2.6.2 с Ambari, установка Worker Installation при сбое нескольких хостов.

После успешной установки веб-сервера и планировщика на главном узле, то есть на узле имени, целью было установить Celery worker на всех узлах данных, чтобы группы DAG могли работать параллельно и масштабироваться по горизонтали и вертикали.

Но Амбари дал дурацкие выражения :) с ошибкой ниже.

 

Решение:

Это означает, что pip не может загрузить и установить wheel на машину, когда я пытался установить worker на узле с помощью пользовательского интерфейса Ambari. Однако с помощью команд терминала я смог запустить те же команды для установки wheel’s of pip.

Обычное решение для этой ошибки было запущено с аргументом доверенного пользователя или с изменением репозитория, из которого pypi загружает колесо.

 

Пробовал сделать, что указал выше, но снова не удалось. Появился стек других ошибок, но с аналогичным значением.

 

Я обновил pip, но безуспешно.

Наконец я понял, Hack не может быть разрешением, которое сработало, - это команды, которые я установил в celery и все необходимые колеса pip, которые перечислены здесь.

Но все же он выдал ту же ошибку. Но когда эти колеса были установлены, это не игнорировалось. Согласно коду https://github.com/miho120/ambari-airflow-mpack/blob/e1c9ca004adaa3320e35ab7baa7fdb9b9695b635/airflow-service-mpack/common-services/AIRFLOW/1.10.0/package/scripts/airflow_worker_control.py

В кластере я вручную закомментировал эти строки временно (позже отменил изменения после успешной установки воркера) и добавил воркера из Ambari, который работал как шарм :), и этот хак сделал мой день.

После установки worker на другом узле вам может потребоваться перезапуск службы airflowиз Ambari. Вы можете узнать больше из моей предыдущей статьи в блоге; Настройка Multi-Node Airflow Cluster с HDP Ambari и Celery для конвейеров данных
