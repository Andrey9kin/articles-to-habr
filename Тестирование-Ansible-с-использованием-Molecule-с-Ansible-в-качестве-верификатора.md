Тестирование Ansible с использованием Molecule с Ansible в качестве верификатора

В этом руководстве мы будем изучать, как тестировать код инфраструктуры, написанный на Ansible, с использованием инфраструктуры тестирования, известной как Molecule. Внутри Molecule мы будем использовать Ansible в качестве верификатора, чего я пока нигде не мог найти. Давай сделаем это!

 

Содержание

1. Введение

2. Установка Molecule

3. Установка Molecule в Ansible

4. Написание тестов Ansible с помощью Ansible Verifier

5. Выводы

 

1. Введение

Ansible - это инструмент автоматизации ИТ с открытым исходным кодом, используемый в управлении конфигурацией, развертывании приложений, оркестровке инфраструктурных служб, облачном обеспечении и многом другом. Это простой в использовании инструмент, но при этом упрощает выполнение очень сложных повторяющихся задач автоматизации ИТ. Его можно использовать для многоуровневого развертывания ИТ-приложений.

Как и в любой другой сфере  ИТ, тестирование неизбежно. Непроверенную инфраструктуру можно легко списать на уже сломанную инфраструктуру. Тестируя код инфраструктуры, мы обеспечиваем разработку кода инфраструктуры производственного уровня, лишенного ошибок и ошибок, которые могут оказаться очень дорогостоящими, если не будут обнаружены до производства.

Molecule - это фреймворк, предназначенный для помощи в разработке и тестировании ролей в Ansible. По состоянию на 26 сентября Ansible объявила о принятии Molecule и Ansible-lint в качестве официальных проектов Red Hat Ansible. Это показывает уверенность сообщества Red Hat в этом инструменте и объем работы, который они прилагают, чтобы сделать его еще лучше и лучше.

Molecule позволяет тестировать роли в разных экземплярах, операционных системах и дистрибутивах, поставщиках виртуализации, тестовых средах и сценариях тестирования.

Molecule поддерживает TDD-подобную форму кода инфраструктуры тестирования. В этом руководстве мы рассмотрим жизненный цикл, которому, по моему мнению, должно следовать тестирование Molecule.

 

2. Установка Molecule

Предполагается, что читатель уже имеет некоторый опыт управления пакетами в системах UNIX.

Для работы Molecule необходимы следующие пакеты:

- Python 2.7 или Python 3.5 или выше (в этом руководстве мы будем использовать Python 3.7)

- Ansible 2.5 или выше (для этого урока мы будем использовать Ansible 2.9.6)

- Docker (последняя версия)

Pip - единственный официально поддерживаемый менеджер пакетов для установки Molecule. Если вы используете Python 2.7.9 (или выше) или Python 3.4 (или выше), то PIP по умолчанию устанавливается вместе с Python.

Чтобы установить Molecule с помощью pip:

 

Дополнительные советы по установке см. В разделе «Установка Molecule». Чтобы проверить, правильно ли установлена Molecule, запустите $ Molele --version.

При тестировании Ansible Playbooks важно понимать, что мы не проверяем, что Ansible работает, т.е. что Ansible выполнил свою работу, например, по созданию файла, пользователя или группы, а мы проверяем, что наше намерение, как выражено простым английским языком, соответствует декларативному языку Ansible, то есть то, что было создано, - это именно то, что мы хотели создать, и не было человеческих ошибок (например, типографских ошибок или упущений).

 

3. Установка Molecule в Ansible

Есть два способа установки Molecule для тестирования ролей Ansible:

а. Установка Molecule с новой ролью Ansible

Molecules использует Ansible Galaxy для создания стандартного макета ролей Ansible. Чтобы создать новую роль с помощью Molecule:

 

б. Иницизилизация **Initiating для** уже существующей роли Ansible

Molecule также можно использовать для тестирования уже существующих ролей, просто введите следующую команду в корневом каталоге, где находится роль, или внутри каталога ролей, убедившись, что имена ролей совпадают: 

 

Независимо от того, как вы инициализируете Molecule, новая папка Molecule добавляется в корневую папку проекта. В результате макет папки выглядит следующим образом:

 

Ниже мы обсудим содержимое папки Molecule и их использование:

 

molecule.yml

В файле molle.yml мы указываем всю конфигурацию Molecule, необходимую для проверки ролей.

 

**dependency**:

Это диспетчер зависимостей, который отвечает за разрешение всех зависимостей ролей. Ansible Galaxy - это зависимость по умолчанию, используемая Molecule. Другие менеджеры зависимостей - Shell и Gilt. По умолчанию для зависимости установлено значение true, но ее можно отключить, установив для параметра enabled значение false.

 

**driver**:

Драйвер сообщает Molecule, откуда мы хотим получить наши тестовые экземпляры. Драйвер Molecule по умолчанию - Docker, но есть и другие варианты, такие как: AWS, Azure, Google Cloud, Vagrant, Hetzner Cloud и многие другие. См. Драйверы Molecule для получения дополнительной информации.

 

**platforms**:

Ключ платформы указывает, какой тип инстансов мы хотим запустить для тестирования наших ролей. Это должно соответствовать драйверу, например, в приведенном выше фрагменте, он говорит, какой тип образа докера мы хотим запустить.

 

**provisioner:** 

Provider - это инструмент, который запускает файл converge.yml для всех запущенных экземпляров (указанных в платформах). Единственный поддерживаемый провайдер - Ansible.

 

**verifier:** 

Верификатор - это инструмент, который проверяет наши роли. Этот верификатор запускает файл verify.yml, чтобы убедиться, что фактическое состояние нашего экземпляра (состояние схождения) соответствует желаемому состоянию (состояние проверки). Верификатор по умолчанию - Ansible, но есть и другие верификаторы, такие как: testinfra, goss и inspec. Раньше testinfra был верификатором по умолчанию, но из-за необходимости в унифицированном тестировании UX и во избежание необходимости изучать другой язык, Python, в случае testinfra сообщество решило, что Ansible станет верификатором по умолчанию, и я поддерживаю это решение. . См. Проблему с g ИТ здесь.

 

Дополнительные ключи, которые не генерируются по умолчанию, - это lint и сценарий. Эти ключи могут быть добавлены в файл Molevel.yml по желанию.

 

**lint:** 

Lint представляет, какой инструмент Molecule должен использовать, чтобы гарантировать обнаружение и пометку декларативных ошибок, ошибок, стилистических ошибок и подозрительных конструкций. Популярные линты - ямлинт, анзибл-линт, хлопья8 и др.

 

**scenario:** 

Сценарий описывает жизненный цикл теста Molecule. Сценарий тестирования можно настроить, поскольку шаги в последовательности можно менять местами или закомментировать, чтобы соответствовать любому необходимому сценарию. У каждой роли должен быть сценарий по умолчанию, который называется по умолчанию.

Если не указано иное, имя сценария - это обычно имя каталога, в котором расположены файлы Molecule. Ниже приведен сценарий по умолчанию, запускаемый при запуске соответствующей последовательности команд:

 

Из приведенного выше фрагмента мы можем сказать, что происходит, когда мы запускаем команду Molecule, например, $ Molecule create будет запускать, затем create_sequence, а $ Molele check запустит check_sequence и так далее.

 

В общем, мы добавляем ключ сценария только тогда, когда мы хотим настроить наш сценарий, иначе это не нужно, так как это сценарий по умолчанию и, следовательно, неявный.

 

Converge.yml

Файл converge.yml, как следует из названия, используется для преобразования состояния экземпляров в реальное состояние, объявленное в реальных тестируемых ролях. Он запускает одиночную конвергентную игру на запущенных экземплярах. Этот файл запускается, когда мы запускаем команду $ molecule converge.

 

verify.yml

Файл verify.yml запускает игру, которая вызывает тестовые роли. Эти роли используются для проверки того, что состояние уже конвергированного экземпляра соответствует желаемому состоянию. Этот файл запускается, когда мы запускаем команду $ Molele verify.

 

INSTALL.rst

Этот файл содержит инструкции по дополнительным зависимостям, необходимым для успешного взаимодействия между Molecule и драйвером.

 

4. Написание тестов Ansible с помощью Ansible Verifier

В этом разделе мы будем практиковать то, что, на мой взгляд, должно быть рабочим процессом для тестирования ролей Ansible с использованием верификатора Ansible в Molecule.

Выполнение $ molecule test запускает всю test_sequence, но всегда уничтожает созданные экземпляры в конце, и это может занять много времени, учитывая, что мы должны воссоздавать экземпляры каждый раз, когда мы вносим изменения в наши фактические или тестовые роли.

Таким образом, рабочий процесс, который соответствует подходу BDD, следующий:

 

В приведенном выше фрагменте данная фаза не меняется часто, поэтому мы просто создаем экземпляр (ы) один раз. После этого мы выполняем итерацию между этапами когда и затем, пока все наши тесты не будут проверены и не будут содержать ошибок.

В этом руководстве наша цель - реализовать TDD при тестировании нашей инфраструктуры. Мы бы писали модульные тесты. Допустим, мы хотели реализовать роль под названием alpha-services, которая решала следующие задачи:

 

- Задача 1. Устанавливает Java-1.8 на хост-машину.
- Задача 2: Создает каталог по пути / var / log / tomcat, принадлежащий владельцу «tomcat», группе «tomcat» и режиму «0755»
- Задача 3. Устанавливает, запускает и включает httpd
- Задача 4. Скопируйте файл шаблона из template / tomcat / context.xml в /etc/tomcat/context.xml

Сначала мы создаем роль, используя команду Molecule инициализации:

 

Это создает макет папки, подобный показанному ранее. Далее мы создаем путь alpha-services / scheme / default / roles / test_alpha-services:

 

Здесь будут содержаться наши тестовые роли. Внутри каталога test_alpha-services мы

создайте наши тестовые роли, используя стандартный макет ролей Ansible (мы создаем только те папки, которые нам нужны для тестирования, в данном случае значения по умолчанию, задачи и вары). Каждая созданная папка должна иметь свой файл main.yml. Для отдельной задачи мы создадим отдельные файлы yml, чтобы различать их друг от друга, добавив к имени задачи префикс test_. Например, задача по установке java будет называться test_java.yml.

 

Тогда у нас останется следующий макет папок: 

 

Настраиваем файл Molle.yml:

 

Мы оставляем файл converge.yml как есть:

 

Мы редактируем файл verify.yaml, чтобы включить в него вашу роль поставщика тестов:

 

GIVEN ФАЗА: Мы запускаем $ Molele create для создания экземпляров.

 

WHEN ФАЗА: Мы запускаем $ molecule converge для выполнения фактических ролей, которые еще предстоит реализовать. Это не повлияет на созданный экземпляр.

 

Теперь перейдем к развитию ролей.

Следуя подходу TDD, мы сначала создаем тесты и проверяем, что они не работают, прежде чем реализовывать роли, которые они тестируют.

 

ЗАДАЧА 1. Установите Java-1.8.0 на хост-машину

Задача проверки статуса пакета Java пытается установить java-1.8.0 в режиме проверки и регистрирует результат этой операции в pkg_status. Фактически, если java-1.8.0 уже установлен, утверждение not pkg_status.changed вернет true, потому что состояние не изменилось бы. Спасибо Хуану Антонио за этот совет.

Мы включаем задачи test_java.yml в файл alpha-services / Molele / default / roles / test_alpha-services / tasks / main.yml следующим образом:

 

THEN ЭТАП: Запускаем $ Molele verify. Как и ожидалось, произойдет сбой со следующей ошибкой:

Теперь мы реализуем Задачу 1. Сначала мы создаем файл alpha-services / tasks / java.yml и заполняем его следующим:

 

Затем мы включаем задачи java.yml в файл alpha-services / tasks / main.yml следующим образом:

 

WHEN ФАЗА: Теперь мы запускаем $ molecule converge, чтобы произвести изменения в экземпляре.

 

THEN ФАЗА: Здесь мы запускаем $ molecule verify, которая должна пройти тест, если фаза схождения прошла успешно.

 

ЗАДАЧА 2. Создайте каталог по пути / var / log / tomcat, принадлежащий владельцу «tomcat», группе «tomcat» и режиму «0755»

Мы определяем переменные в yml-файле тестовых значений по умолчанию Molecule:

Первая задача использует модуль статистики Ansible для получения статуса файловой системы, а вторая задача проверяет соответствие статусов.

Затем мы включаем задачу test_java.yml в файл alpha-services / Molele / default / roles / test_alpha-services / tasks / main.yml следующим образом:

 

После этого мы продолжаем запускать $ molecule verify, которая по праву терпит неудачу, как и в предыдущем тесте. Поэтому мы реализуем актуальную задачу:

Мы определяем переменные в файле yml фактических значений по умолчанию для роли:

Мы включаем задачи tomcat.yml в файл alpha-services / tasks / main.yml следующим образом:

 

КОГДА ФАЗА: Теперь мы запускаем $ molecule converge, чтобы произвести изменения в экземпляре.

ТОГДА ФАЗА: Затем мы запускаем $ molecule verify, которая должна пройти тест, если фаза схождения прошла успешно.

 

ЗАДАЧА 3: Установить, запустить и включить httpd

Мы не будем тестировать эту задачу, потому что Ansible делает это за нас. Как указано в документации Ansible, «ресурсы Ansible - это модели желаемого состояния. Таким образом, нет необходимости проверять, запущены ли службы, установлены ли пакеты или что-то подобное. Ansible - это система, которая гарантирует декларативную истинность этих вещей ».

Таким образом, если служба не завершает работу, а мы пытаемся ее запустить, задача завершится ошибкой, показанной ниже:

Поэтому будем реализовывать только задачу:

 

Стоит отметить, что для запуска httpd в системах Linux требуется systemd, которого по умолчанию нет в контейнерах докеров. Чтобы иметь возможность запускать службу в контейнере докеров, мы добавляем следующий отредактированный ключ платформ в файл Molelele.yml:

 

Для получения дополнительной информации о запуске systemd см. Ссылку.

Теперь мы запускаем $ Molecule create и $ Molelecversion. Если они оба работают успешно, тогда служба httpd запущена и работает. Чтобы вручную проверить службу httpd, мы запускаем:

 

ЗАДАЧА 4. Скопируйте файл шаблона из template / tomcat / context.xml в /etc/tomcat/context.xml

Как и раньше, мы будем проверять наличие именно того файла, который мы хотим скопировать с контроллера в хост-систему. Мы хотим проверить, соответствует ли имя файла ожидаемому и, возможно, присутствует какое-то конкретное содержимое файла, как и ожидалось. Мы могли допустить ошибку при названии файла или создании содержимого файла, и это то, что нам нужно проверить. По умолчанию, если файл не копируется, Ansible сообщит нам об этом.

 

Мы добавляем в соответствующие файлы следующее:

 

После этого мы запускаем $ molecule verify, чтобы убедиться, что она не работает. После этого реализуем актуальные задачи:

 

Затем мы запускаем $ molecule converge, а затем $ molecule verify. Тесты должны пройти, если все сделано правильно.

 

Наконец, чтобы быть уверенным, мы запускаем $ molecule test, чтобы выполнить всю Molecule test_sequence. Все должно работать без сбоев.

 

5. Выводы

В заключение, на мой взгляд, это правильный подход к разработке тестов Molecule для анзибельных ролей. Код инфраструктуры следует протестировать перед развертыванием в производственной среде, чтобы избежать неприятных сюрпризов. Это руководство было простой демонстрацией того, как можно проводить тестирование Ansible с помощью Molecule, используя Ansible Verifier. Таким образом, нет необходимости изучать другой язык программирования, такой как Python, Ruby или Go.
