В этом постое я расскажу о некоторых плюсах и минусах puppet и ansible на большом количестве серверов. А также расскажу о интересной задумке использования puppet и ansible вместе.

Так как я знаю только puppet, то в этом посте будет он. Но возможно это применимо и для Chef, Salt.

### Puppet

#### Обновление системных программ и библиотек

Относительно быстрое и просто реализуемое обновление системных программ и библиотек даже на большом количестве серверов.

Обновления серверов независимые друг от друга. Все сервера могут обновлять свой софт параллельно и не мешая друг другу.

![](https://habrastorage.org/webt/iz/rc/eb/izrceb5c1kvyaluuvangjy03htu.png)

#### Обновление сложнозависимого программного обеспечения, canary deployment, rollup deployment и так далее

Обновление сложнозависимого программного обеспечения, canary deployment, rollup deployment автоматически невозможно.

![](https://habrastorage.org/webt/w0/80/si/w080sitrrk91sxxspwev8n0kcbc.png)

Допустим что приложение обновилось успешно. Допустим что приложение можно обновлять синхронно. Тогда будет такая картина.

![](https://habrastorage.org/webt/m2/-n/jk/m2-njkhpvxpehjn4up-jepbmn-m.png)



Допустим что обновление приложения завершилось неудачей. В логах приложения появились ошибки. Но так как puppet обновляет синхронное, то оба приложения становятся нерабочими. Клиенты получают ошибку 502.

![](https://habrastorage.org/webt/wa/m3/uo/wam3uooqq-gkg8efaecr_2uigls.png)

Затем из конфигурации Service Discovery удаляется информация об обоих приложениях. Балансировщик ничего не знает об этих приложениях. У клиентов не работает сервис.

![](https://habrastorage.org/webt/wg/a-/zz/wga-zzwkylwmlg9currbqasbzya.png)

Как можно эмулировать rollup deployment при puppet.

Выключается puppet на балансировщике и на одном из серверов приложений.

Обновляется сервер приложений, на который не идет клиентский трафик. 

Если приложение говорит что оно работает хорошо, то включаем этот сервер приложений на балансировщике. В балансировке участвуют две версии приложения: первая и вторая.

Теперь обновляем приложение на втором сервере. Отключаем второй сервер на балансировщике.

Итого приложения обновлены.

### Ansible

#### Обновление системных программ и библиотек

Не такое быстрое, но просто реализуемое обновление системных программ и библиотек. На большом количестве серверов будем происходит медленне чем у Puppet.

Обновления серверов могут быть независимые друг от друга, а могут быть зависимые от других серверов. Сервера могут обновлять свой софт параллельно и не мешая друг другу. Количество параллельных коннектов Ansible меньше чем у Puppet.

#### Обновление сложнозависимого программного обеспечения, canary deployment, rollup deployment и так далее

Обновление сложнозависимого программного обеспечения, canary deployment, rollup deployment автоматически один из плюсов Ansible.

Исходное состояние: версии приложений на обоих серверах равны "1".

![](https://habrastorage.org/webt/db/jj/7d/dbjj7dhycqvrkurbltoo-7dvala.png)

Обновляем первый сервер. Для этого его нужно отключить от клиентского трафика. Тут два пути.

При остановке приложения на первом сервере в service discovery удаляется завись об этом сервере.

Второй путь: Ansible может сам пойти в Service discovery и удалить запись о первом сервере.

![](https://habrastorage.org/webt/yk/63/5x/yk635xhgw3ypgviewscsdzdbloe.png)

Затем Ansible проверяет работоспособность приложения на новой версии.

Если приложение работает и heathcheck выдает 200 OK, то Ansible переходит ко второму серверу.

Если приложение не работает и heathcheck выдает 500 ошибку, то Ansible устанавливает первую версию приложения. На самом деле вы дожны этот всю логику написать или взять готовую в интернете.

![](https://habrastorage.org/webt/mq/1u/i7/mq1ui7a0n_t8d-i0xqbpishdcq0.png)

Допустим что приложение заработало. Ansible будет обновлять приложение на втором сервере.

![](https://habrastorage.org/webt/6l/rd/cg/6lrdcgqslvcdus-lxyswmaw4vn8.png)

Ansible проверяет работоспособность приложения на новой версии.

Если приложение работает и heathcheck выдает 200 OK, то работа Ansible закончена.

Если приложение не работает и heathcheck выдает 500 ошибку, то Ansible устанавливает первую версию приложения.

![](https://habrastorage.org/webt/ar/ln/xq/arlnxqi4-sgqhifdg2usm6v9t2a.png)

Приложение на втором сервере через некоторое количество секунд зарегистрирует себя в Service Discovery.

![](https://habrastorage.org/webt/mi/oh/8u/mioh8udwbzwakbqvkaoentzjfbq.png)

#### Puppet для обновления системных программ и библиотек. Ansible для обновления сложнозависимого программного обеспечения, canary deployment, rollup deployment и так далее.

А теперь совестим Puppet и Ansible. На малых проектах мало выгоды от использования Puppet и Ansible. А вот на больших проектах с сотнями или тысячами серверов выгода возможна.

![](https://habrastorage.org/webt/vn/nq/2d/vnnq2di_ked1my93jlqee4c6bos.png)

В этой схеме вы можете на тысячи серверов обновлять системное программное обеспечение и в то же время на выбранных серверах обновлять свои приложения с помощью canary deployment, rollup deployment или как-нибудь других методов.





Добавить обновление прижения при изменении версии API и добавлении полей в БД.