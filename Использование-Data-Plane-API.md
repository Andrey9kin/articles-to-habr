Использование Data Plane API 

API HAProxy Data Plane – это программа, которая работает вместе с HAProxy, чтобы вы могли полностью настроить балансировщик нагрузки HAProxy во время выполнения.



Эта функция позволяет использовать ряд вариантов использования, подходящих для динамически создаваемой конфигурации.



Лучшим примером является использование HAProxy в качестве плоскости данных сервисной сетки в архитектуре микросервисов, где центральная плоскость управления управляет конфигурацией набора прокси-серверов sidecar.



В этом разделе показано, как установить и настроить API плоскости данных и начать работу с несколькими примерами.



См. также спецификации API документации для более подробной информации.



Предпосылки

HAProxy Community 1.9 или новее (2.0 при использовании Process Manager)



HAProxy Enterprise 1.9 или новее



Рабочие знания HTTP и использование REST API



Установка API плоскости данных

Установите API графических интерфейсов с предприятия

API Data Plane поставляется в виде системного пакета, который вы можете установить с помощью apt или yum.



Ниже приведен пример установки на сервере Ubuntu 18.04.



Храните свой корпоративный ключ HAProxy в переменной с именем haproxy_key и добавьте ключ репозитория HAProxy apt:



Выполните команду add-apt-repository, чтобы включить следующие репозитории пакетов:



Установите пакет API плоскости данных следующим образом:



$ sudo apt install hapee-extras-dataplane-api

Это добавляет программы: /opt/hapee-extras/sbin/hapee-dataplane-api.



Установите API с сообществом HAProxy

API Data Plane поставляется в виде программы, которую вы можете скачать с Github.



После загрузки установите его разрешения на запуск в качестве исполняемого файла и скопируйте его в папку на вашем пути:



Настройка доступа пользователя к HAProxy

API плоскости данных требует, чтобы вы включили базовую аутентификацию, что означает, что любой пользователь, вызывающий его методы, должен предоставить действительные учетные данные.



Имена пользователей и пароли хранятся в конфигурационном файле HAProxy внутри раздела userlist. Список пользователей – это раздел верхнего уровня, такой как frontend и backend.



Добавьте следующее в конфигурационный файл HAProxy /etc/hapee-1.9/hapee-lb.cfg:



В этом примере мы добавили одного пользователя с именем dataplaneapi и паролем mypassword.



Вы также можете зашифровать пароль с помощью команды mkpasswd из пакета whois.



Скопируйте и вставьте зашифрованный пароль в файл конфигурации:



Вам не нужно перезагружать HAProxy, чтобы список пользователей вступил в силу.



Однако если API плоскости данных запущен, остановите его, а затем перезапустите.



API работает в своем собственном процессе, что позволяет ему записывать и перезагружать конфигурацию HAProxy по мере необходимости.



Настройка доступа к сокету HAProxy

Data Plane API нуждается в доступе для чтения и записи в сокет HAProxy.



Для этого обновите конфигурационный файл HAProxy так, чтобы он имел строку сокета статистики в глобальном разделе:



Задайте параметры пользователя и группы пользователей системы, которые будут использовать API. Например, с графических интерфейсов сообщества, можно задать как для графических интерфейсов. Они должны быть установлены в hapee-lb и hapee соответственно для HAProxy Enterprise, как показано на рисунке:



Если вы протестируете API, запустив его самостоятельно, вы можете добавить свое собственное имя пользователя в ту же группу:



ПРИМЕЧАНИЕ

Если вы сделаете это, убедитесь, что вы выходите из системы и снова входите в нее, чтобы разрешения вступили в силу.



Запуск API

Основное использование API заключается в следующем:



Ниже перечислены параметры редактирования и управления экземплярами HAProxy.



Вы можете вызвать API с флагом --help, чтобы просмотреть список доступных опций.



Параметры применения

Эти параметры управляют тем, как размещается Data Plane API и как он должен управлять завершением работы.



Параметр



Описание



--scheme=



Подключить слушателей. Можно повторить и по умолчанию использовать схемы в спецификации swagger



--cleanup-timeout=



Льготный период, в течение которого следует подождать, прежде чем уничтожать бездействующие соединения (default: 10s)



--graceful-timeout=



Льготный период ожидания перед выключением сервера (default: 15s)



--max-header-size=



Управляет максимальным числом байтов, которые сервер будет считывать при анализе ключей и значений заголовка запроса, включая строку запроса. Он не ограничивает размер тела запроса. (default:1MiB)



--socket-path=



Сокет Unix для прослушивания (default: /var/run/data-plane.sock)



--host=



IP-адрес для прослушивания (default: localhost) [$HOST]



--port=



Порт для прослушивания небезопасных соединений; по умолчанию используется случайное значение [$PORT]



--listen-limit=



Ограничивает количество невыполненных запросов



--keep-alive=



Устанавливает тайм-ауты TCP keep-alive для принятых подключений. Он обрезает мертвые TCP-соединения (например, закрытие ноутбука в середине загрузки) (default: 3m)



--read-timeout=



Максимальная продолжительность ожидания для чтения запроса перед тайм-аутом (default: 30s)



--write-timeout=



Максимальная продолжительность ожидания для записи ответа перед тайм-аутом (default: 60s)



--tls-host=



IP-адрес для прослушивания TLS; если он не указан, то это то же самое, что и --host [$TLS_HOST]



--tls-port=



Порт для прослушивания защищенных соединений; по умолчанию используется случайное значение [$TLS_PORT]



--tls-certificate=



Сертификат, используемый для безопасных соединений [$TLS_CERTIFICATE]



--tls-key=



Закрытый ключ, используемый для безопасных соединений [$TLS_PRIVATE_KEY]



-- tls-ca=



Файл центра сертификации для использования с mutual tls auth [$TLS_CA_CERTIFICATE]



--tls-listen-limit=



Ограничивает количество невыполненных запросов



--tls-keep-alive=



Устанавливает тайм-ауты TCP keep-alive для принятых подключений. Он обрезает мертвые TCP-соединения (например, закрытие ноутбука в середине загрузки)



--tls-read-timeout=



Максимальная продолжительность ожидания для чтения запроса перед тайм-аутом



--tls-write-timeout=



Максимальная продолжительность ожидания для записи ответа перед тайм-аутом



Параметры HAProxy

Эти параметры настраивают доступ и управление с помощью API работающего экземпляра HAProxy.



Параметр



Описание



-c, --config-file=



Путь к HAProxy файл конфигурации (default: файл /etc/haproxy/haproxy.cfg)



-u, --userlist= 



Список пользователей в конфигурации HAProxy для использования для базовой аутентификации API (default: controller)



-b, --haproxy-bin=



Путь к двоичному файлу HAProxy (default: haproxy)



-d, --reload-delay= 



Минимальная задержка между двумя перезагрузками (в секундах) (default: 5)



-r, --reload-cmd=



Команда перезагрузки



-s, --restart-cmd=



Команда перезапуска



--reload-retention=



Сохранение перезагрузки в днях, каждый более старый идентификатор перезагрузки будет удален (default: 1)



-t, --transaction-dir=



Путь к каталогу транзакций (default: /tmp/haproxy)



-n, --backups-number=



Количество резервных конфигурационных файлов, которые вы хотите сохранить, хранящихся в config dir с суффиксом номера версии (default: 0)



-m, --master-runtime=



Путь к основному сокету API среды выполнения



-i, --show-system-info



Показать системную информацию на конечной точке info



Параметры ведения журнала

Эти параметры настраивают уровень ведения журнала для запросов к API.



Параметр



Описание



--log-to=[stdout|file]



Цель журнала, может быть stdout или file (default: stdout)



--log-file=



Расположение файла журнала (default: /var/log/dataplaneapi/dataplaneapi.log)



--log-level=[trace|debug|info|warning|error]



Уровень ведения журнала (default: warning)



--log-format=[text|JSON]



Формат ведения журнала (default: text)



Другие параметры

Эти параметры предоставляют дополнительную информацию об API.



Параметр



Описание



-v, --version



Показать информацию о версии и сборке



-h, --help



Показать эту справку (справочное сообщение) 



Запустить Data Plane API с HAProxy Enterprise



Запустить Data Plane API как сервис

При запуске в качестве службы параметры Data Plane API такие же, как и при использовании CLI. Вы можете установить эти параметры в файле /etc/default/hapee-extras-dataplane-api.



Заменить 1.9 в по умолчанию сервиса файл с вашей версией HAProxy Enterprise:



Включите сервис:



Запустить службу:



Отображение API в браузере

При запущенном API откройте браузер и получите доступ к спецификации OpenAPI на порту 5555, например http://localhost:5555/v1/specification.



Это возвращает документ JSON, который определяет все доступные методы API.



В Firefox вы получаете удобочитаемую версию с разборными разделами. Узел пути содержит URL-адреса, которые сопоставляются с каждым методом.



[Firefox отображает файл спецификации в дружественном виде]

Методы исследований

Вы можете использовать команду curl для тестирования вызова различных методов.



Вызовите метод info, который возвращает информацию о процессе:



Если вы получите эту ошибку:



Это означает, что пользователь, который запускает API, не имеет доступа к сокету HAProxy. Убедитесь, что вы добавили его в группу HAProxy, и снова войдите в систему.



ПРИМЕЧАНИЕ

Задача Data Plane API состоит в том, чтобы полностью управлять конфигурационным файлом HAProxy. Поэтому каждый раз, когда вы редактируете конфигурацию вручную, убедитесь, что вы перезапустили API или отправили ему сигнал SIGUSR2, чтобы он мог снова прочитать файл. Ниже приведены примеры использования этих команд.



Использование диспетчера процессов HAProxy

При использовании HAProxy 2.0 или более поздней версии вы можете использовать HAProxy Process Manager для запуска Data Plane API. Process Manager добавляет новый раздел под названием Программа в конфигурацию HAProxy для запуска внешних процессов при запуске HAProxy.



Настройка HAProxy для начала API

Следующая конфигурация запускает Data Plane API при запуске процесса HAProxy. Нет параметра (отсутствие) start-on-reload на строке позволяет избежать перезагрузки Data Plane API каждый раз, когда к HAProxy перезагружается.



Обновление конфигурации HAProxy:



Чтобы это сработало, вы должны запустить HAProxy в режиме master-worker, добавив директиву master-worker в свой глобальный раздел (или добавив аргумент командной строки-W). Затем, когда вы просматриваете статус HAProxy, вы увидите новую программу, работающую вместе с рабочими процессами HAProxy.



Если HAProxy запускается внутри контейнера Docker в режиме master-worker (который используется по умолчанию), вы можете использовать команду kill-SIGUSR2 [PID] для аргумента --reload-cmd, где PID всегда равен 1, чтобы перезагрузить только рабочие процессы HAProxy без завершения главного процесса контейнера.



Использование Data Plane API

В этом разделе мы покажем вам команды, которые вы можете использовать с Data Plane API.



GET запросы 

При извлечении данных с помощью GET-запросов вам не нужны никакие дополнительные параметры URL-адреса. Например, чтобы получить список интерфейсов в вашей конфигурации, используйте:



Это возвращает документ JSON с двумя ключами верхнего уровня: _version и data.



Версия отображается в верхней части конфигурационного файла HAProxy и увеличивается всякий раз, когда вы записываете данные с помощью запроса POST, PUT или DELETE. Это гарантирует, что изменения в файле не конфликтуют.



Ключ данных содержит результат выполнения команды, который в данном случае представляет собой массив объектов, описывающих каждый интерфейс.



POST запросы 

При записи данных, например с помощью POST-запроса, необходимо включить версию в URL-адрес. Если он не соответствует текущей версии, вы получаете ошибку о несоответствии версии.



Ниже приведен пример запроса POST на добавление нового интерфейса:



СОВЕТ

Это хорошая идея, чтобы заключить URL-адрес в кавычки, так что оболочка не интерпретирует любой параметр URL с префиксом амперсанда как запрос на выполнение команды в фоновом режиме.



Использование транзакций

При выполнении приведенного выше запроса возникают следующие проблемы:



Если вы не определили be_web, то получите сообщение об ошибке, указывающее, что API не может найти серверную часть.



API создает интерфейс без линии привязки.



Чтобы устранить эти проблемы, вы можете выполнить следующие команды только один раз в следующей последовательности:



Создать бэкенд be_web



Добавить сервера к бэкенду



Создание внешнего интерфейса



Добавьте строку привязки к внешнему интерфейсу



Каждая из этих операций требует отдельной команды; и пока вы не выполнили их все, вы продолжаете перезагружать конфигурацию HAProxy с допустимыми, но неполными данными. Решение состоит в том, чтобы использовать транзакцию, которая хранит команды, а затем применяет их все сразу.



Инициализация транзакции: 



Затем каждая команда, выполняемая в рамках этой транзакции, включает параметр transaction_id в URL-адрес. Для просмотра всех транзакций используйте следующую команду:



Добавить бэкэнд:



Добавить сервер в бэкэнд:



Добавьте внешний интерфейс:



Добавьте строку привязки к внешнему интерфейсу:



После завершения транзакции примените изменения:



Monitor Configuration Reloads



Data Plane API с --reload-delay или -d для установки временного интервала между перезагрузками. Например, если вы установили задержку в пять секунд, то каждые пять секунд программа проверяет, не было ли каких-либо изменений, требующих перезагрузки HAProxy. Если ничего не найдено, API ждет еще пять секунд и проверяет снова. Все изменения, которые происходят в промежутке между проверками, ждут следующей проверки, прежде чем они будут применены. Другими словами, команда не вызывает перезагрузку. Перезагрузка происходит автоматически через равные промежутки времени по мере необходимости.



Используйте конечную точку /services/haproxy/reloads, чтобы получить список выполняемых и неудачных перезагрузок. Это может быть использовано для проверки того, что конфигурация была успешно обновлена.



Можно перезагрузить HAProxy сразу же, минуя параметр force_reload=true URL при вызове команды.



Пример конфигурации

Следующий пример добавляет ACL с именем is_api к интерфейсу с именем test_frontend.



Добавьте ACL с именем is_api:



Результат:



Добавьте строку use_backend, которая ссылается на ACL is_api:



Результат:



Удалите строку use_backend (обратите внимание, что мы передаем идентификатор 0 в URL-адрес):



Добавьте встроенный ACL, который отклоняет все запросы, кроме запросов от localhost:



Конфигурация HAProxy теперь выглядит следующим образом:



В данном разделе представлена HAProxy Data Plane API, который позволяет настроить HAProxy HTTP-запросы к процессу, который запускается независимо от HAProxy.



Существуют методы для создания прокси, бэкендов, серверов, ACLs (списков управления доступом), правил таблиц и многого другого.



Смотрите дополнительные сведения о доступных командах в документации по спецификации API. 

