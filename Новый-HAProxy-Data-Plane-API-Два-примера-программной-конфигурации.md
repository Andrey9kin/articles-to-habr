**Новый HAProxy Data Plane API: два примера программной конфигурации**

Используйте HAProxy Data Plane API для динамического управления конфигурацией балансировщика нагрузки с помощью HTTP-команд.

Проектирование для высокой доступности почти всегда означает наличие высокого уровня прокси / балансировщика нагрузки. Прокси-сервер предоставляет основные услуги, такие как:

- обнаружение и удаление неисправных серверов
- очередь соединений
- разгрузка шифрования TLS
- компрессия
- кэширование

Задача состоит в том, чтобы поддерживать ваши конфигурации в актуальном состоянии, что особенно сложно, поскольку сервисы перемещаются в контейнеры, и эти контейнеры становятся эфемерными.  Доступный начиная с [HAProxy 2.0](https://www.haproxy.com/blog/haproxy-2-0-and-beyond/) вы можете использовать новый [HAProxy Data Plane API](https://www.haproxy.com/documentation/hapee/1-9r1/configuration/dataplaneapi/), который является современным REST API.

HAProxy Data Plane API дополняет [гибкий язык конфигурации](https://www.haproxy.com/blog/the-four-essential-sections-of-an-haproxy-configuration/) HAProxy, который предоставляет строительные блоки для определения простых и сложных правил маршрутизации. Это также идеальное дополнение к существующему [Runtime API](https://www.haproxy.com/blog/dynamic-configuration-haproxy-runtime-api/), которое позволяет запускать, останавливать и пропускать трафик с серверов, изменять вес сервера и управлять проверками работоспособности.

Новый Data Plane API дает вам возможность динамически добавлять и настраивать внешние интерфейсы, внутренние интерфейсы и логику маршрутизации трафика. Вы также можете использовать его для обновления конечных точек ведения журнала и создания фильтров SPOE. По сути, почти весь балансировщик нагрузки может быть настроен с помощью HTTP-команд. В этой статье вы узнаете, как лучше его использовать.

**Управление конфигурацией**

Обычно при настройке HAProxy вам нужно вручную отредактировать файл конфигурации `/etc/haproxy/haproxy.cfg`. Этот файл используется для управления всеми функциями балансировщика нагрузки. Он в основном разделен на `frontend` разделы, определяющие общедоступные IP-адреса, к которым подключаются клиенты, и `backend` разделы, содержащие вышестоящие сервера, на которые направляется трафик. Но вы можете сделать гораздо больше, в том числе установить глобальные параметры, влияющие на работающий процесс, установить значения по умолчанию, добавить анализ поведения трафика с помощью таблиц флеш-памяти, прочитать файлы карт, определить правила фильтрации с помощью ACL и многое другое.

Хотя редактировать файл вручную довольно просто, это не всегда целесообразно, особенно при работе с десятками или даже сотнями сервисов и прокси. Это позволяет всему трафику проходить от прокси к прокси, по существу абстрагируя сеть и ее непостоянство от смежных сервисов приложений. Прокси на этом уровне могут добавить к вашим услугам  логику повторных попыток, авторизацию и шифрование TLS. Тем не менее, количество прокси будет быстро расти, так как для каждой услуги есть свой прокси.

В этом случае крайне важно иметь возможность вызвать HTTP API для динамического обновления определений прокси. В сервисной сетке программное обеспечение Data Plane контролирует прокси и динамически вызывает API конфигурации. HAProxy Data Plane API позволяет интегрировать HAProxy с этими платформами. Более того, API использует API времени выполнения для внесения изменений, которые по возможности не требуют перезагрузки.

```
Data Plane API использует конфигурационный анализатор пакетов Go и собственного клиента для синтаксического анализа конфигурации HAProxy и вызова команд API времени выполнения соответственно. Вы можете использовать их в своих собственных проектах для интеграции с HAProxy.
```

**Динамическое конфигурирование HAProxy**

С помощью Data Plane API вы можете многое сделать. В этом разделе вы узнаете, как создать серверную часть с серверами и интерфейсом, который направляет трафик на него. Но сначала следуйте официальной документации по установке и настройке API.

После того как он будет  установлен и запущен, вызовите GET в конечной точке / v1 / services / haproxy / configuration / backends, чтобы увидеть уже определенные разделы серверной части, например:

Если вы хотите добавить новый бэкэнд, вызовите ту же конечную точку с помощью POST. Есть два способа внести изменения в это состояние - индивидуальные вызовы или пакетные команды внутри транзакции. Поскольку мы хотим внести несколько связанных изменений, давайте начнем с создания транзакции.

Вызовите конечную точку / v1 / services / haproxy / Transactions для создания новой транзакции. Для этого потребуется параметр версии в URL, но командам внутри транзакции он не нужен. Всякий раз, когда вызывается команда POST, PUT или DELETE, должна быть включена версия, которая затем записывается в файл конфигурации HAProxy. Это гарантирует, что если несколько клиентов будут использовать API, они избежат конфликтов. Если версия, которую вы передаете, не соответствует версии, указанной в файле конфигурации, вы получите сообщение об ошибке. При использовании транзакции эта версия указывается заранее при ее создании.

Вы найдете идентификатор транзакции в возвращенном документе JSON:

Затем используйте конечную точку / v1 / services / haproxy / configuration / backends, чтобы создать новый бэкэнд, отправив идентификатор транзакции в качестве параметра URL:

Затем вызовите конечную точку / v1 / services / haproxy / configuration / servers для добавления серверов в бэкэнд:

Затем добавьте внешний интерфейс с помощью конечной точки / v1 / services / haproxy / configuration / frontends:

У этого веб-интерфейса еще нет никаких обязательных заявлений. Добавьте одно, используя конечную точку / v1 / services / haproxy / configuration / binds, как на примере:

Затем, чтобы зафиксировать транзакцию и применить все изменения, вызовите конечную точку / v1 / services / haproxy / Transactions / [transaction ID] с помощью PUT, например:

Вот как выглядит конфигурация сейчас:

Этот балансировщик нагрузки готов принимать трафик и перенаправлять его на вышестоящий сервер.

Поскольку в спецификации Data Plane API используется OpenAPI, его можно использовать для генерации клиентского кода на многих поддерживаемых языках программирования.

Во время этого упражнения мы упаковали все команды внутри транзакции. Вы также можете вызывать их одну за другой. В этом случае вместо включения параметра URL с именем transaction_id вы должны включить одну версию, которая будет увеличиваться с каждым вызовом.

**Другой пример**

Вы увидели простоту и мощь Data Plane API HAProxy. С помощью нескольких HTTP-команд вы можете динамически изменять конфигурацию. Давайте рассмотрим другой пример. Мы создадим ACL, который будет проверятьимеет ли заголовок узла значение example.com. Если это так, то строка use_backend будет направлена на другой сервер с именем example_servers. Мы также добавим правило запрета http-запросов, которое будет отклонять любые запросы для пути URL /admin.php, если исходный IP-адрес клиента не находится в сети 192.168.50.20/24.

Сначала используйте конечную точку / v1 / services / haproxy / Transactions для создания новой транзакции и получения ее идентификатора:

Используйте конечную точку / v1 / services / haproxy / configuration / servers для добавления сервера в бэкэнд:

Используйте конечную точку / v1 / services / haproxy / configuration / acls, чтобы определить ACL с именем is_example, который проверяет, имеет ли заголовок узла значение example.com:

Используйте / v1 / services / haproxy / configuration / backend_switching_rules, чтобы добавить строку use_backend, которая оценивает ACL is_example:

Используйте конечную точку / v1 / services / haproxy / configuration / http_request_rules, чтобы добавить правило запрета http-запроса, которое проверяет, является ли путь /admin.php, а исходный IP-адрес клиента не находится в сети 192.168.50.20/24:

Затем подтвердите транзакцию, чтобы изменения вступили в силу:

Ваша конфигурация HAProxy теперь выглядит вот так:

**Заключение**

В этой статье вы ознакомились с HAProxy Data Plane API, который позволяет полностью настроить HAProxy с использованием современного REST API. Более подробную информацию можно найти в официальной документации. У него имеются три мощных функции, которые включают гибкий язык конфигурации HAProxy и API времени выполнения. Data Plane API открывает двери для многостороннего использования, в частности, с использованием HAProxy в качестве уровня прокси в сетке сервиса.

Мы рады будущему использованию нового API для создания новых партнерских отношений и разнообразных функций. HAProxy продолжает обеспечивать высокую производительность и устойчивость в любой среде и в любом масштабе.

Если вам понравилась эта статья и вы хотите быть в курсе похожих тем, подпишитесь на этот блог. Вы также можете подписаться на нас в Twitter. HAProxy Enterprise позволяет легко приступить к работе с Data Plane API, поскольку его можно установить в виде удобного системного пакета. Он также включает в себя надежную и передовую кодовую базу, корпоративный набор дополнений, экспертную поддержку и профессиональные услуги. Хотите узнать больше? Свяжитесь с нами сегодня и скачайте бесплатную пробную версию.



