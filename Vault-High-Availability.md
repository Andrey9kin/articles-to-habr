Режим высокой доступности Vault (HA)

Vault может работать в режиме высокой доступности (HA) для защиты от сбоев за счет запуска нескольких серверов Vault. Vault обычно ограничивается пределами операций ввода-вывода серверной части Vault, а не требованиями к вычислениям. Некоторые серверные модули хранения, например Consul, предоставляют дополнительные функции координации, которые позволяют Vault работать в конфигурации высокой доступности, в то время как другие обеспечивают более надежный процесс резервного копирования и восстановления. 

При работе в режиме высокой доступности серверы Vault имеют два дополнительных состояния: резервное и активное. В кластере Vault активным будет только один экземпляр, который будет обрабатывать все запросы (чтение и запись), а все резервные узлы перенаправляют запросы на активный узел.

 

ПРИМЕЧАНИЕ. Начиная с версии 0.11, эти резервные узлы могут обрабатывать большинство запросов только для чтения и вести себя как узлы реплики для чтения. Эта функция Performance Standby Nodes включена в Vault Enterprise Premium, а также доступна для Vault Enterprise Pro за дополнительную плату. Это особенно полезно для обработки больших объемов запросов. Прочтите документацию по рабочим узлам и руководство для получения более подробной информации.

 

Это руководство проведет вас через простую реализацию кластера Vault Highly Available (HA). Хотя это не исчерпывающее или предписывающее руководство, которое можно использовать в качестве примера прямого подключения, оно охватывает основы, достаточные для информирования вашей собственной производственной установки.

 

Примерное время на выполнение 

25 минут 

 

Предпосылки

Это промежуточное руководство по работе с Vault предполагает, что у вас есть практические знания о Vault и Consul.

 

Шаги

Наша цель в этом руководстве, - настроить Vault HA, состоящий из: 

·    2 серверов Vault:  1 активный и 1 резервный 

·    Кластер из 3-х серверов Consul  

 

Справочная диаграмма 

На этой диаграмме для справки показаны простые детали архитектуры:

 

Мы будем выполнять эти шаги: 

·    Шаг 1. Настройка кластера серверов Consul 

·    Шаг 2. Запуск и проверка состояния кластера Consul 

·    Шаг 3. Настройка клиентских агентов Consul на узлах Vault 

·    Шаг 4. Настройка серверов Vault 

·    Шаг 5. Запуск Vault и его проверка 

 

Для реализации целей этого руководства мы будем использовать программное обеспечение с открытым исходным кодом Vault и Consul; настройка будет аналогична для версии Enterprise.

 

Шаг 1. Настройка кластера серверов Consul 

Наши серверы Consul в этом руководстве будут определяться только IP-адресом, но также обозначены меткой:

Двоичный файл Consul находится в / usr / local / bin / consul, но если в вашем случае не так, вы можете соответствующим образом изменить ссылки на пути.

 

Обратите внимание, что некоторые значения содержат заполнители переменных, а остальные имеют разумные значения по умолчанию. Вы должны заменить следующие значения в вашей конфигурации сервера Consul на основе примера:

·    $ NODE_NAME - это уникальная метка для узла; в нашем случае это будут consul_s1, consul_s2 и consul_s3 соответственно. 

·    $ CONSUL_DATA_PATH: абсолютный путь к каталогу данных Consul; убедитесь, что этот каталог доступен для записи пользователю процесса Consul. 

·    $ ADVERTISE_ADDR: задает адрес, чтобы серверы Consul объявляли другим серверам в кластере. Не должно быть установлено в 0.0.0.0; для этого руководства он должен быть установлен на IP-адрес сервера Consul в каждом экземпляре файла конфигурации или 10.1.42.101,10.1.42.102 и 10.1.42.103 соответственно. 

·    $ JOIN1, $ JOIN2, $ JOIN3: в этом примере используется метод retry_join для присоединения агентов сервера к формированию кластера; Таким образом, значения для этого руководства будут 10.1.42.101, 10.1.42.102 и 10.1.42.103 соответственно.

 

Обратите внимание, что веб-интерфейс пользователя включен («ui»: true), и Consul будет вести журнал на уровне DEBUG в системный журнал («log_level»: «DEBUG»). Для целей этого руководства acl_enforce_version_8 установлено в false, поэтому нам не нужно беспокоиться о списках ACL в этом руководстве. Тем не менее, вы могли бы включить списки ACL в производственной среде и следовать руководству Consul ACL. 

Создайте файл конфигурации для каждого сервера Vault и сохраните его как /usr/local/etc/consul/client_agent.json. 

 

consul_s1.json Пример

 

Консул Сервер systemd 

У вас есть двоичные файлы Consul и базовая конфигурация, и теперь вам просто нужно запустить Consul на каждом экземпляре сервера; systemd популярен в большинстве современных дистрибутивов Linux, поэтому, имея это в виду, вот пример файла systemd unit:

 

Обратите внимание, что вас может заинтересовать изменение следующих значений в зависимости от стиля, стандартного уровня соблюдения иерархии файловой системы и т. Д. –

·    **config-file** 

·    **pid-file**

 

После того как файл модуля определен и сохранен (например, /etc/systemd/system/consul.service), обязательно выполните перезагрузку демона systemctl daemon-reload, а затем вы можете запустить службу Consul на каждом сервере.

 

Шаг 2. Запуск и проверка состояния кластера Consul

Убедитесь, что права собственности и разрешения верны в каталоге, который вы указали для значения data_dir, а затем запустите службу Consul в каждой системе и проверьте статус:

 

После запуска всех агентов сервера Consul, давайте проверим статус кластера Consul:

 

Кластер выглядит хорошо, показаны все 3 сервера; Прежде чем продолжить, убедитесь, что у нас есть лидер:

 

Приведенный выше вывод показывает, что consul_s3 является текущим лидером кластера в этом примере. Теперь вы можете перейти к настройке сервера Vault.

 

Шаг 3. Настройка клиентских агентов Consul на узлах Vault

Узлам сервера Vault требуются двоичные файлы Consul и Vault на каждом узле. Consul будет настроен как агент клиента, а Vault будет настроен как сервер.

 

Конфигурация агента клиента Consul

Поскольку Consul используется для обеспечения серверной части высокодоступного хранилища, вам необходимо настроить локальные клиентские агенты Consul на серверах Vault, которые будут взаимодействовать с кластером серверов Consul для регистрации проверок работоспособности, обнаружения служб и координации переключения HA кластера (лидерство кластера).

Обратите внимание, что не рекомендуется подключать серверы Vault напрямую к серверам Consul.

Агенты клиента Consul будут использовать тот же адрес, что и серверы Vault, для сетевой связи с кластером серверов Consul, но они будут связывать client_address только с интерфейсом обратной связи, так что Vault может подключиться к нему через интерфейс обратной связи. 

Вот пример конфигурации для агента клиента Consul:

 

Аналогично тому, что вы сделали на шаге 1, замените следующие значения в своей конфигурации агента клиента Consul соответственно: 

·    $ NODE_NAME - это уникальная метка для узла; в нашем случае это будут consul_c1 и consul_c2 соответственно. 

·    $ CONSUL_DATA_PATH: абсолютный путь к каталогу данных Consul; убедитесь, что этот каталог доступен для записи пользователю процесса Consul. 

·    $ BIND_ADDR: это должно быть установлено на адрес, который вы предпочитаете, чтобы серверы Consul объявляли другим серверам в кластере, и не должно быть установлено на 0.0.0.0; в этом руководстве он должен быть установлен на IP-адрес сервера Vault в каждом экземпляре файла конфигурации или 10.1.42.201 и 10.1.42.202 соответственно. 

·    $ JOIN1, $ JOIN2, $ JOIN3: в этом примере используется метод retry_join для присоединения агентов сервера для формирования кластера; Таким образом, значения для этого руководства будут 10.1.42.101, 10.1.42.102 и 10.1.42.103 соответственно.

 

Создайте файл конфигурации для каждого сервера Vault и сохраните его как /usr/local/etc/consul/client_agent.json.

 

consul_c1.json Пример

 

Консул Сервер systemd 

 

У вас есть двоичные файлы Consul и базовая конфигурация агента клиента, и теперь вам просто нужно запустить Consul на каждом из экземпляров сервера Vault. Вот пример файла модуля systemd:

 

При необходимости измените следующие значения: 

·    -config-file

·    -pid-file

 

После того как файл модуля определен и сохранен (например, /etc/systemd/system/consul.service), обязательно выполните перезагрузку демона systemctl daemon-reload, а затем вы можете запустить службу Consul на каждом сервере Vault. 

Запустите Consul и проверьте его состояние кластера, чтобы убедиться, что права собственности и разрешения верны в каталоге, который вы указали для значения data_dir, а затем запустите службу Consul в каждой системе и проверьте статус:

 

После запуска всех клиентских агентов Consul проверьте статус кластера Consul:

 

Приведенные выше выходные данные показывают 3 агента сервера Consul и 2 агента клиента Consul в кластере. Теперь вы можете настроить серверы Vault.

 

Шаг 4. Настройка серверов Vault

Теперь, когда у нас есть кластер Consul, состоящий из 3-х серверов и 2-х клиентских агентов для наших серверов Vault, давайте вместе получим конфигурацию для Vault и сценарий запуска, чтобы мы могли запустить настройку Vault HA.

Наши серверы Vault в этом руководстве определяются только IP-адресом, но также обозначаются меткой:

- **vault_s1:     10.1.42.201**
- **vault_s2:     10.1.42.202**

В нашем файле конфигурации мы настроим следующее:

- **tcp** listener
- **consul** storage     backend
- High     Availability parameters

В этом разделе предполагается, что двоичный файл Vault находится в / usr / local / bin / vault.

 

Конфигурация Vault

Мы устанавливаем следующие параметры для нашего tcp-слушателя:

·    address ("127.0.0.1:8200") - указывает адрес, к которому нужно привязаться для прослушивания. 

·    cluster_address («127.0.0.1:8201») - указывает адрес для привязки для запросов кластера сервер-сервер. По умолчанию это значение на один порт больше, чем значение адреса. Обычно это не требуется настраивать, но может быть полезно в случае, если серверы Vault изолированы друг от друга таким образом, что им нужно переключаться через балансировщик нагрузки TCP или какую-либо другую схему для разговора.

Эта конфигурация позволяет прослушивать все интерфейсы (например, так, чтобы команда Vault для адреса обратной связи была успешной).

Мы также устанавливаем параметры высокой доступности Vault (api_addr и cluster_addr). Чаще всего нет необходимости настраивать эти два параметра при использовании Consul в качестве серверной части хранилища Vault, поскольку Consul будет пытаться автоматически обнаруживать и объявлять адрес активного узла Vault. Однако для некоторых конфигураций кластера может потребоваться их явная установка (например, доступ к Vault через балансировщик нагрузки). 

Для простоты предположим, что клиенты в нашем сценарии подключаются непосредственно к узлам Vault (а не через балансировщик нагрузки). Просмотрите документацию  Client Redirection, чтобы получить дополнительную информацию о шаблонах доступа клиентов и их последствиях. 

Обратите внимание, что некоторые значения содержат заполнители переменных, а остальные имеют разумные значения по умолчанию. Вы должны заменить следующие значения в конфигурации вашего собственного сервера Vault на основе примера:

·    $ API_ADDR: указывает адрес (полный URL) для объявления другим серверам Vault в кластере для перенаправления клиентов. Это также можно сделать с помощью переменной среды VAULT_API_ADDR. Как правило, это должен быть полный URL-адрес, указывающий на значение адреса слушателя. В нашем сценарии это будут http://10.1.42.201:8200 и http://10.1.42.202:8200 соответственно. 

·    $ CLUSTER_ADDR: указывает адрес для объявления другим серверам Vault в кластере для пересылки запросов. Это также можно сделать с помощью переменной среды VAULT_CLUSTER_ADDR. Это полный URL, например api_addr. В нашем сценарии это будут https://10.1.42.201:8201 и https://10.1.42.202:8201 соответственно.

 

Обратите внимание, что схема здесь (https) игнорируется; все члены кластера всегда будут использовать TLS с закрытым ключом / сертификатом.

vault_s1.hcl Пример

 

Сервер Vault systemd 

У вас есть двоичные файлы Vault и базовая конфигурация вместе с настроенными локальными агентами клиента. Теперь вам просто нужно запустить Vault на каждом экземпляре сервера. Вот пример файла модуля systemd:

 

Обратите внимание, что вас может заинтересовать изменение следующих значений в зависимости от стиля, стандартного уровня соблюдения иерархии файловой системы и т. д.

- **-config**
- **-log-level**

Как только файл модуля определен и сохранен, например, /etc/systemd/system/vault.service, обязательно выполните перезагрузку демона systemctl daemon-reload, а затем вы можете запустить службу Vault на каждом сервере.

 

Шаг 5. Запуск Vault и его проверка

Запустите службу Vault в каждой системе и проверьте состояние:

Теперь вам нужно перейти к инициализации и распечатыванию каждого экземпляра Vault. 

Как только это будет сделано, проверьте статус Vault на каждом из серверов. 

Активный сервер Vault:

Резервный сервер Vault:

 

Теперь серверы Vault  работают в режиме высокой доступности (HA), и вы можетезаписать секрет из активного или резервного экземпляра Vault и увидеть его успешное выполнение в качестве теста пересылки запросов. Кроме того, вы можете закрыть активный экземпляр (sudo systemctl stop vault), чтобы смоделировать сбой системы и увидеть, как резервный экземпляр принимает на себя лидерство.

 

Следующие шаги

Прочтите «Повышение безопасности производства», чтобы узнать о передовых методах развертывания Vault для повышения уровня защиты в производственной среде.
